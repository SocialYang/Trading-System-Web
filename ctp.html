<!DOCTYPE html>
<head>
<link rel="stylesheet" href="src/css.css" />
<meta charset="utf-8">
        <script type="text/javascript" 
    		src="src/brython.js">
	    </script>
        </head>

        <body onload="brython()">

        <script type="text/python">
            from browser import document, alert, html, websocket, timer, window
            from browser.local_storage import storage
            import json,time,datetime

            EVENT_LOG = 'eLog'                          # 日志事件，通常使用某个监听函数直接显示
            EVENT_MARKETDATA = 'eMarketData'            # 行情推送事件
            EVENT_MARKETDATA_CONTRACT = 'eMarketData.'  # 特定合约的行情事件
            EVENT_TRADE = 'eTrade'                      # 成交推送事件
            EVENT_TRADE_CONTRACT = 'eTrade.'            # 特定合约的成交事件
            EVENT_ERROR = 'eError'                      # Error推送事件
            EVENT_ORDER = 'eOrder'                      # 报单推送事件
            EVENT_ORDER_ORDERREF = 'eOrder.'            # 特定报单号的报单事件
            EVENT_POSITION = 'ePosition'                # 持仓查询回报事件
            EVENT_INSTRUMENT = 'eInstrument'            # 合约查询回报事件
            EVENT_INVESTOR = 'eInvestor'                # 投资者查询回报事件
            EVENT_ACCOUNT = 'eAccount'                  # 账户查询回报事件

            funcs={
            }

            count = 100

            def add_log(content):
                some = html.DIV(html.LABEL(content)+html.HR())
                _l = document['log'].children
                document['log'].clear()
                document['log']<=some
                for one in _l[:count]:
                    document['log']<=one


            if 'ctp_server' in storage:
                add_log("服务器地址:"+storage['ctp_server'])
                address = 'ws://'+storage['ctp_server']+":8080/websocket"
            else:
                add_log("服务器地址:本地")
                address = 'ws://localhost:8080/websocket'

            ws = websocket.WebSocket(address)
            idTimer = 1

            def ws_msg(ev):
                _msg = json.loads(ev.data)
                _type = _msg.get('_type_','EmptyType')
                if _type in funcs:
                    funcs[_type](_msg)
                else:
                    add_log(ev.data)


            def circle_msg():
                ws.send("circlemsg=%s"%datetime.datetime.now())
                timer.set_timeout(circle_msg, 1000)

            def secend_one():
                if 'ctp_account' in storage:
                    _acc = json.loads(storage['ctp_account'])
                    if _acc:
                        ws.send("ws_ctpaccount="+storage['ctp_account'])
                        timer.set_timeout(secend_two, 1000)
                    else:
                        add_log(html.A("请先设置ctp信息",href="settings.html"))
                else:
                    add_log(html.A("请先设置ctp信息",href="settings.html"))

            def secend_two():
                add_log("确认帐户信息")
                timer.set_timeout(secend_three, 1000)

            def secend_three():
                add_log("启动循环消息")
                timer.set_timeout(circle_msg, 1000)

            def reconnect():
                add_log("重连ing")
                window.location.reload()

            def ws_open():
                add_log("连接服务器端")
                timer.set_timeout(secend_one, 1000)

            def ws_error():
                add_log("!!!websocket连接报错!!!")

            def ws_disconnected():
                add_log("服务器端断开连接,3秒后尝试重连")
                idTimer = timer.set_timeout(reconnect, 3000)

            ws.bind('message',ws_msg)
            ws.bind('close',ws_disconnected)
            ws.bind('open',ws_open)
            ws.bind('error',ws_error)
        </script>
<body>
<div class="grid-100 align-center">
            <h1>CTP监控终端</h1>
<hr/>
<div class="grid-50 grid-parent">
  <p class="grid-100 align-center">
    <b>
      行情显示
    </b>
  </p>
  <div class="grid-100 align-center" id="hangqing">
        ...
  </div>
<br/>
<hr/>
</div>
<div class="grid-50 grid-parent">
  <p class="grid-100 align-center">
    <b>
      账户净值
    </b>
  </p>
  <div class="grid-100 align-center" id="account">
        ...
  </div>
<br/>
<hr/>
</div>
<div class="grid-100 grid-parent">
  <div class="grid-33 align-left">
    <section class="example-block">
      <b>成交</b>
      <span class="dynamic-px-width"></span>
      <div id="trade">
      <p><label id="aaa" class="example-block">asd</label><hr/><p/>
      <p><label id="aaa" class="example-block">asd</label><hr/><p/>
      <p><label id="aaa" class="example-block">asd</label><hr/><p/>
      <p><label id="aaa" class="example-block">asd</label><hr/><p/>
        </div>
    </section>
  </div>
  <div class="grid-33 align-center" style="background-color:#ccc;">
    <section class="example-block">
      <b>报单</b>
      <span class="dynamic-px-width"></span>
      <div id="order">
      <p><label id="aaa" class="example-block">asd</label><hr/><p/>
      <p><label id="aaa" class="example-block">asd</label><hr/><p/>
      <p><label id="aaa" class="example-block">asd</label><hr/><p/>
      <p><label id="aaa" class="example-block">asd</label><hr/><p/>
        </div>
    </section>
  </div>
  <div class="grid-33 align-right">
    <section class="example-block">
      <b>日志</b>
      <span class="dynamic-px-width"></span>
      <div id="log"/>
    </section>
  </div>
</div>
</div>

        </body>

    </html>